# Audio Assistant on Azure Static Web Apps

This project delivers a web-based audio chat assistant built with Expo Router. Users can upload existing audio clips or record directly in the browser and receive high-quality transcriptions generated by OpenAI's `gpt-4o-mini-transcribe` model. The front end is ready for Azure Static Web Apps, and an Azure Functions backend keeps your OpenAI API key protected on the server.

## Features

- **Audio uploads** – Select any audio file and receive a transcript in the chat timeline.
- **In-browser recording** – Use the MediaRecorder API (web browsers) to capture new notes on the fly.
- **Secure transcription API** – Audio is sent to an Azure Function that calls OpenAI; API keys never leave the backend.
- **Configurable secrets** – Store your OpenAI key through the in-app Settings tab or rotate it with a direct API call to the Functions backend.
- **One-click deployment** – A GitHub Actions workflow builds the Expo web app and publishes both the front end and functions to Azure Static Web Apps.

## Project structure

```text
my-ai-app/
├── app/                     # Expo Router screens
│   └── (tabs)/index.tsx     # Audio chat experience
├── api/                     # Azure Functions project
│   └── src/functions/transcribe
│       ├── function.json    # Azure Functions binding config
│       └── index.js         # Transcription proxy
├── staticwebapp.config.json # SPA routing config for Azure Static Web Apps
└── .github/workflows/       # Deployment workflow
```

## Prerequisites

- Node.js 20.19.4+ and npm 10.8+
- Expo CLI (`npx expo`) for local development
- Azure Functions Core Tools v4 (for local API testing)
- An OpenAI API key with access to the Whisper/gpt-4o transcription models
- An Azure Static Web Apps instance (free tier works great)

## Local development

1. **Install dependencies**

   ```bash
   npm install
   npm install --prefix api
   ```

2. **Configure environment variables**

   - Create `api/local.settings.json` from the provided example:

     ```bash
     cp api/local.settings.json.example api/local.settings.json
     ```

   - Edit the new file and set both `OPENAI_API_KEY` and `OPENAI_PROXY_TOKEN`. The proxy token is an arbitrary secret string that the client must present when calling `/api/transcribe`.
   - Before starting Expo, export the same proxy token so the web app can authenticate requests:

     ```bash
     export EXPO_PUBLIC_TRANSCRIBE_API_KEY="<your-proxy-token>"
     ```

     If you are using an Azure Functions host key instead of a proxy token, set `EXPO_PUBLIC_AZURE_FUNCTIONS_KEY` with that value instead.
   - (Optional) If you are running the Azure Functions host on a different port or domain, expose it to the Expo app by setting `EXPO_PUBLIC_API_BASE_URL` in your shell before starting Expo, e.g.

     ```bash
     export EXPO_PUBLIC_API_BASE_URL="http://localhost:7071"
     ```

3. **Run the backend (Azure Functions)**

   ```bash
   npm run start --prefix api
   ```

   By default the HTTP endpoint will be available at `http://localhost:7071/api/transcribe`. Include `x-api-key: <proxy-token>` (or `x-functions-key`) when calling the endpoint.

4. **Run the Expo web app**

   ```bash
   npx expo start --web
   ```

   Open the provided URL in a modern browser. Upload an audio file or record a note to see transcripts appear in the chat.

5. **Optional: configure the OpenAI key without editing files**

   Visit the **Settings** tab in the app to store your OpenAI API key securely on the local Functions host. The screen calls the
   `/api/openai-settings` endpoint, which you can also invoke manually:

   ```bash
   curl http://localhost:7071/api/openai-settings \
     -H "Content-Type: application/json" \
     -d '{"apiKey":"sk-your-key"}'
   ```

   A `GET` request reports whether a key is stored, and `DELETE` removes the saved value.

## Azure deployment

1. **Create a Static Web App** in the Azure Portal and connect it to your GitHub repository.
2. **Set secrets** in your GitHub repository settings:
   - `AZURE_STATIC_WEB_APPS_API_TOKEN` – deployment token from the Static Web App resource.
3. **Configure application settings** for the Azure Functions backend (in the Azure Portal under *Configuration*):
   - `OPENAI_API_KEY` – your production OpenAI key. You can also set or rotate the key after deployment via the `/api/openai-settings` endpoint (see below).
   - `OPENAI_PROXY_TOKEN` – a secret string that authorizes access to `/api/transcribe`. This must match the client-side `EXPO_PUBLIC_TRANSCRIBE_API_KEY` value used during the Expo build.
   - `EXPO_PUBLIC_TRANSCRIBE_API_KEY` – the same proxy token so the Expo web build can authenticate browser requests. (Alternatively, set `EXPO_PUBLIC_AZURE_FUNCTIONS_KEY` if you prefer to authorize with an Azure Functions host key.)
   - `AzureWebJobsFeatureFlags` – set the value to `EnableWorkerIndexing`. Static Web Apps currently hosts the Functions runtime
     with worker indexing disabled by default. Without this flag, the new JavaScript programming model that this repo uses will
     deploy successfully but all requests return **404 Not Found** because the runtime never discovers the `chat` and `openai-settings`
     endpoints. If the Azure portal reports **AppSettings is invalid** with the message `AppSetting with name(s)
     'AzureWebJobsFeatureFlags' are not allowed`, use the Azure CLI instead:

     ```bash
     az staticwebapp appsettings set \
       --name <your-static-web-app-name> \
       --setting-names AzureWebJobsFeatureFlags=EnableWorkerIndexing
     ```

     The CLI bypasses the portal validation bug and correctly stores the setting for the managed Functions host.
     If the command exits with `ModuleNotFoundError: No module named 'msrestazure'`, your Azure CLI installation is missing a dependency that the Static Web Apps extension requires.
     Run the following to repair the CLI and reinstall the extension, then retry the `az staticwebapp appsettings set` command:

     ```bash
     az upgrade --yes
     az extension remove --name staticwebapp
     az extension add --name staticwebapp
     ```

     Ignore the removal error if the extension was not previously installed.
     On Windows you may need to reopen the terminal after `az upgrade` so the refreshed Python environment is picked up.
4. **Push to `main`**. The included workflow `.github/workflows/azure-static-web-app.yml` will:
   - Install dependencies and export the Expo project to static assets (`dist/`).
   - Install Azure Functions dependencies.
   - Publish the front end and API to your Static Web App.

## Security considerations

- The OpenAI API key is **never** exposed to the client. It lives only in the Azure Functions configuration (locally via `local.settings.json`, in production via Azure app settings).
- CORS headers are handled inside the Azure Function to allow the Static Web App to communicate with the API securely.
- The `/api/transcribe` endpoint refuses requests that do not include the `OPENAI_PROXY_TOKEN`, so only trusted clients can stream audio through the proxy.
- The repository does **not** commit any secrets. Ensure `api/local.settings.json` is kept out of version control.

## Troubleshooting

- **`npm WARN EBADENGINE` during install** – Install Node.js 20.19.4 or later. The Expo SDK 54 toolchain requires the newer runtime and its matching npm release. Tools such as `nvm`, `fnm`, or Volta can help pin the correct version.
- **Recording button disabled** – In-browser recording relies on the MediaRecorder API, which is available in most evergreen browsers. If it is unavailable, upload audio files instead.
- **Transcription errors** – Check the Functions log output. Typical issues include missing `OPENAI_API_KEY`, network restrictions, or unsupported audio codecs.
- **Deployment failures** – Confirm the GitHub secret `AZURE_STATIC_WEB_APPS_API_TOKEN` is set and the Static Web App resource is configured to use the workflow from this repository.
- **API responds with 404** – Verify that `AzureWebJobsFeatureFlags=EnableWorkerIndexing` is present in the Static Web App
  configuration and re-run the deployment workflow. You can confirm the function is available by requesting the transcription endpoint:

  ```bash
  curl https://<your-static-web-app>.azurestaticapps.net/api/transcribe \
    -H "x-api-key: <your-proxy-token>"
  ```

  A healthy deployment responds with `{ "ok": true, "message": "Transcription proxy is ready." }`.

## Next steps

- Add authentication to restrict who can submit audio for transcription.
- Persist chat history by storing transcriptions in Azure Cosmos DB or another database.
- Extend the Azure Function to support translation or summarisation alongside transcription.
